<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SWF Inspector</title>
    <link type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.17/themes/base/jquery-ui.css" rel="Stylesheet"/>
    <style>
      body {
        margin: 0;
        font-family: helvetica;
        font-size: 13px;
        color: #454545;
      }
      h3 {
        margin: 0;
      }
      .error {
        color: #cd0a0a;
      }
      #menu {
        height: 15px;
        padding: 15px 10px;
        border-top: 2px solid #888;
        border-bottom: 1px solid #aaa;
      }
      #info {
        height: 15px;
        padding: 5px 10px;
        text-align: right;
        background: #ccc;
        border-top: 1px solid #d3d3d3;
        border-bottom: 1px solid #aaa;
      }
      #sidebar {
        position: absolute;
        left: 0;
        top: 75px;
        bottom: 0;
        margin: 0;
        width: 280px;
        padding: 0;
        overflow: auto;
        background: #e6e6e6;
        border-right: 1px solid #d3d3d3;
      }
      #sidebar li {
        height: 14px;
        padding: 10px;
        border-bottom: 1px solid #d3d3d3;
        list-style-type: none;
        cursor: pointer;
      }
      #sidebar li:hover {
        background: #fbf9ee;
      }
      #sidebar li.active {
        background: #fcefa1;
      }
      #sidebar li > span {
        display: inline-block;
        width: 30px;
        color: #888;
      }
      #graph {
        position: absolute;
        left: 0;
        top: 75px;
        right: 0;
        bottom: 0;
        margin: 0 301px 0 281px;
        padding: 10px;
        overflow: auto;
      }
      #preview {
        position: absolute;
        top: 75px;
        right: 0;
        bottom: 0;
        width: 280px;
        padding: 10px;
        text-align: center;
        background: url(no_bg.png);
        border-left: 1px solid #d3d3d3;
      }
      #timeline {
        display: none;
        position: absolute;
        left: 0;
        top: 75px;
        right: 0;
        margin-left: 281px;
        height: 70px;
        overflow: hidden;
        background: url(timeline_bg.png);
      }
      #timeline .unit {
        position: absolute;
        bottom: 42px;
        margin-left: -21px;
        font-size: smaller;
      }
      #playhead {
        position: absolute;
        left: -20px;
        top: -35px;
        margin: 1px;
        width: 17px;
        height: 15px;
        background: url(playhead.png);
      }
      #storyboard {
        position: absolute;
        top: 35px;
        height: 35px;
        background: url(frame.png);
        cursor: pointer;
      }
      body.timeline #timeline {
        display: block;
      }
      body.timeline #preview {
        left: 280px;
        width: auto;
        padding-top: 80px;
      }
    </style>
  </head>
  <body class="timeline">
    <div id="menu">
      <h3>Shumway SWF Inspector</h3>
    </div>
    <div id="info">Drop a SWF File</div>
    <ul id="sidebar"></ul>
    <pre id="graph"></pre>
    <div id="preview"></div>
    <div id="timeline">
      <script>
        var i = 0;
        while (i++ < 50)
          document.write('<div class="unit" style="left:' + (100 * i) + 'px">' + (i * 5) + '</div>');
      </script>
      <div id="storyboard">
        <div id="playhead"></div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>

    <script src="beautify.js"></script>
    <script src="DataView.js"></script>

    <script src="../swf.js"></script>

    <script src="../parser/utils.js"></script>
    <script src="../parser/types.js"></script>
    <script src="../parser/structs.js"></script>
    <script src="../parser/tags.js"></script>
    <script src="../parser/inflate.js"></script>
    <script src="../parser/stream.js"></script>
    <script src="../parser/templates.js"></script>
    <script src="../parser/generate.js"></script>
    <script src="../parser/filter.js"></script>
    <script src="../parser/parse.js"></script>

    <script src="../renderer/render.js"></script>
    <script src="../renderer/factories/shape_factory.js"></script>

    <script>
      var tagCodes = {
        End: 0,
        ShowFrame: 1,
        DefineShape: 2,
        PlaceObject: 4,
        RemoveObject: 5,
        DefineBits: 6,
        DefineButton: 7,
        JPEGTables: 8,
        SetBackgroundColor: 9,
        DefineFont: 10,
        DefineText: 11,
        DoAction: 12,
        DefineFontInfo: 13,
        DefineSound: 14,
        StartSound: 15,
        DefineButtonSound: 17,
        SoundStreamHead: 18,
        SoundStreamBlock: 19,
        DefineBitsLossless: 20,
        DefineBitsJPEG2: 21,
        DefineShape2: 22,
        DefineButtonCxform: 23,
        Protect: 24,
        PlaceObject2: 26,
        RemoveObject2: 28,
        DefineShape3: 32,
        DefineText2: 33,
        DefineButton2: 34,
        DefineBitsJPEG3: 35,
        DefineBitsLossless2: 36,
        DefineEditText: 37,
        DefineSprite: 39,
        FrameLabel: 43,
        SoundStreamHead2: 45,
        DefineMorphShape: 46,
        DefineFont2: 48,
        ExportAssets: 56,
        ImportAssets: 57,
        EnableDebugger: 58,
        DoInitAction: 59,
        DefineVideoStream: 60,
        VideoFrame: 61,
        DefineFontInfo2: 62,
        EnableDebugger2: 64,
        ScriptLimits: 65,
        SetTabIndex: 66,
        FileAttributes: 69,
        PlaceObject3: 70,
        ImportAssets2: 71,
        DefineFontAlignZones: 73,
        CSMTextSettings: 74,
        DefineFont3: 75,
        SymbolClass: 76,
        Metadata: 77,
        DefineScalingGrid: 78,
        DoABC: 82,
        DefineShape4: 83,
        DefineMorphShape2: 84,
        DefineSceneAndFrameLabelData: 86,
        DefineBinaryData: 87,
        DefineFontName: 88,
        StartSound2: 89,
        DefineBitsJPEG4: 90,
        DefineFont4: 91,
      };
      var tagNames = (function() {
        var map = { };
        for (var name in tagCodes)
          map[tagCodes[name]] = name;
        return map;
      })();

      var body = $('body');
      var info = $('#info');
      var sidebar = $('#sidebar');
      var graph = $('#graph');
      var preview = $('#preview');
      var storyboard = $('#storyboard');
      var playhead = $('#playhead');

      var stage;
      var ctx;
      var activeItem;

      function readFile(file) {
        var reader = new FileReader();
        reader.onload = function() {
          try {
            SWF.parse(this.result, function(result) {
              process(file, result);
            });
          } catch (e) {
            info.html('<span class="error">' + e.message + '</span>');
            throw e;
          }
        }
        info.html('Reading ' + file.name + '...');
        reader.readAsArrayBuffer(file);
      }
      function process(file, swf) {
        sidebar.html('');
        graph.html('');
        preview.html('');

        var bounds = swf.bounds;
        var frameWidth = (bounds.xMax - bounds.xMin) / 20;
        var frameHeight = (bounds.yMax - bounds.yMin) / 20;

        stage = $('<canvas>');
        ctx = stage[0].getContext('2d');
        stage.attr('width', frameWidth);
        stage.attr('height', frameHeight);
        if (frameWidth > 280)
          stage.css('width', '280px');

        info.html(
          '<b>' + file.name + '</b>, SWF' + swf.version + ', ' +
          ~~swf.frameRate + 'fps, ' +
          frameWidth + 'x' + frameHeight + 'px'
        );

        sidebar.html('');
        activeItem = $('<li class="active">Main Timeline</li>');
        activeItem.data('mc', swf);
        sidebar.append(activeItem);

        (function createItems(mc, level) {
          var tags = mc.tags;
          for (var i = 0, tag; tag = tags[i]; ++i) {
            var item = $(
              '<li class="level-' + level + '">' +
                '<span>' + i + '</span> ' + tagNames[tag.tag] +
              '</li>'
            );
            item.data('mc', swf);
            item.data('tagNum', i);
            sidebar.append(item);
            if (tag.tag === 39)
              createItems(tag, level + 1);
            else if (tag.tag === 9)
              stage.css('background', 'rgb(' + [tag.red, tag.green, tag.blue].join(',') + ')');
          }
        })(swf, 0);

        setTimeline(swf);
      }
      function setTimeline(mc) {
        preview.html('');
        storyboard.css('width', (20 * mc.frameCount) + 'px');
        storyboard.data('mc', mc);
        showFrame(mc, 0);
        body.removeClass('inspect');
        body.addClass('timeline');
      }
      function showFrame(mc, frameNum) {
        renderFrame(mc, frameNum);
        playhead.css('left', (frameNum * 20) + 'px');
        storyboard.data('currentFrame', frameNum);
      }
      function renderFrame(mc, frameNum) {
        var canvas = ctx.canvas;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        var tags = mc.tags;
        var i = 0;
        var tag;
        while (tag = tags[i++]) {
          if (tag.frameNum === frameNum) {
            if (tag.displayList)
              renderDisplayList(tag.displayList, ctx);
            preview.append(stage);
            break;
          }
        }
      }
      function activate(node) {
        if (activeItem)
          activeItem.removeClass('active');
        node.addClass('active');
        activeItem = node;
        var mc = node.data('mc');
        var tagNum = node.data('tagNum');
        if (tagNum != undefined) {
          var tag = mc.tags[tagNum];
          if (tag.tag === 39)
            setTimeline(tag);
          else
            inspect(mc, tag);
        } else {
          setTimeline(mc);
        }
      }
      function inspect(mc, tag) {
        body.removeClass('timeline');
        body.addClass('inspect');
        graph.html(js_beautify(JSON.stringify(tag)));
        preview.html('');
        if (tag.tag === 1) {
          renderFrame(mc, tag.frameNum);
        } else {
          switch (tag.type) {
          case 'shape':
            var canvas = $('<canvas>');
            var bounds = tag.bounds;
            var width = (bounds.xMax - bounds.xMin) / 20;
            var height = (bounds.yMax - bounds.yMin) / 20;
            canvas.attr('width', width);
            canvas.attr('height', height);
            if (width > 280)
              canvas.css('width', '280px');
            var ctx = canvas[0].getContext('2d');
            var factory = new ShapeFactory(tag);
            factory.render(ctx, {
              scaleX: 0.05,
              scaleY: 0.05,
              skew0: 0,
              skew1: 0,
              translateX: -bounds.xMin / 20,
              translateY: -bounds.yMin / 20
            }, 0);
            preview.append(canvas);
            break;
          }
        }
      }

      body.on('dragenter dragover', function(event) {
        event.stopPropagation();
        event.preventDefault();
      });
      body.on('drop', function(event) {
        event.stopPropagation();
        event.preventDefault();
        readFile(event.originalEvent.dataTransfer.files[0]);
      });
      sidebar.on('click', function(event) {
        if (sidebar.has(event.target))
          activate($(event.target));
      });
      storyboard.on('click', function(event) {
        var frameNum = ~~((event.pageX - $(event.target).offset().left) / 20);
        showFrame(storyboard.data('mc'), frameNum);
      });
      playhead.draggable({
        axis: 'x',
        containment: 'parent',
        grid: [20, 0],
        drag: function(event, ui) {
          var frameNum = ui.position.left / 20;
          if (storyboard.data('currentFrame') !== frameNum)
            showFrame(storyboard.data('mc'), frameNum);
        }
      });
    </script>
  </body>
</html>
