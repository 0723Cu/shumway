<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Flamechart Demo</title>
  <style>
    html, body {
      margin: 0;
    }
    html {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
    body {
      color: white;
      background-color: #333333;
      font: 12px Consolas, "Liberation Mono", Courier, monospace;
      height: 100%;
      width: 100%;
      overflow: auto;
    }
    #container {
      width: 100%;
      height: 500px;
      display: relative;
    }
    canvas {
      background-color: #1a2633;
    }
    button {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <script src="../utilities.js"></script>
  <script src="../gfx/geometry.js"></script>
  <script src="flame.js"></script>
  <script src="references.js"></script>
  <script>

    var Geometry = Shumway.GFX.Geometry;
    var Tools = Shumway.Tools;
    var container = document.getElementById("container");
    var buffer = new Tools.TimelineBuffer();

    getJSON("data/CPU-20140520T092003.json", function(result) {
    //getJSON("data/Profile 1.json", function(result) {
      readChromeCPUProfile(result);
      //readFirefoxCPUProfile(result.profile.threads[0].samples);
    });

    function readFirefoxCPUProfile(samples) {
      var startTime = samples[0].time;
      var currentStack = [];
      var sample;
      for (var i = 0; i < samples.length; i++) {
        sample = samples[i];
        var time = sample.time   - startTime;
        var stack = sample.frames;
        for (var j = 0; j < Math.min(stack.length, currentStack.length); j++) {
          if (stack[j].location !== currentStack[j].location) {
            break;
          }
        }
        var leaveCount = currentStack.length - j;
        for (var k = 0; k < leaveCount; k++) {
          sample = currentStack.pop();
          buffer.leave(sample.location, time);
        }
        for (; j < stack.length; j++) {
          sample = stack[j];
          buffer.enter(sample.location, time);
        }
        currentStack = stack;
      }
      while (sample = currentStack.pop()) {
        if(currentStack.length) {
          buffer.leave(sample.location, time);
        }
      }

      var flameChart = new Tools.FlameChart(container, buffer);
    }

    function readChromeCPUProfile(profile) {
      var startTime = profile.timestamps[0] / 1000;
      var currentStack = [];
      var idMap = {};
      var sample;
      resolveIds(profile.head, idMap);
      for (var i = 0; i < profile.timestamps.length; i++) {
        var time = profile.timestamps[i] / 1000 - startTime;
        var stack = [];
        sample = idMap[profile.samples[i]];
        while (sample) {
          stack.unshift(sample);
          sample = sample.parent;
        }
        for (var j = 0; j < Math.min(stack.length, currentStack.length); j++) {
          if (stack[j] !== currentStack[j]) {
            break;
          }
        }
        var leaveCount = currentStack.length - j;
        for (var k = 0; k < leaveCount; k++) {
          sample = currentStack.pop();
          buffer.leave(sample.functionName, time);
        }
        for (; j < stack.length; j++) {
          sample = stack[j];
          buffer.enter(sample.functionName, time);
        }
        currentStack = stack;
      }
      while (sample = currentStack.pop()) {
        if(currentStack.length) {
          buffer.leave(sample.functionName, time);
        }
      }

      var flameChart = new Tools.FlameChart(container, buffer);
    }

    function resolveIds(parent, idMap) {
      idMap[parent.id] = parent;
      if (parent.children) {
        for (var i = 0; i < parent.children.length; i++) {
          parent.children[i].parent = parent;
          resolveIds(parent.children[i], idMap);
        }
      }
    }

    function getJSON(url, callback) {
      var req = new XMLHttpRequest();
      req.open("get", url, true);
      req.responseType = "json";
      req.onreadystatechange = function() {
        if (this.readyState == 4) {
          callback(req.response);
        }
      };
      req.send(null);
    }

    /*
    function testA(size) {
      var t = 0;
      function next() {
        return t += Math.random() / 1;
      }
      for (var i = 0; i < size; i++) {
        buffer.enter("A", next());

        for (var z = 0; z < 10; z++) {
          var k = 1 + (Math.random() * 7) | 0;
          for (var j = 0; j < k; j++) {
            buffer.enter(String(z + j), next());
          }
          for (var j = 0; j < k; j++) {
            buffer.leave(String(z + j), next());
          }
        }

        buffer.leave("A", next());
      }

      var flameChart = new Tools.FlameChart(container, buffer);
    }

    testA(1000);
    */

  </script>
</body>
</html>
