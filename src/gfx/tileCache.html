<!DOCTYPE html>
<html>
<head>
  <title></title>
  <style>
    body {
      color: white;
      font: 12px Consolas, "Liberation Mono", Courier, monospace;
    }

    canvas {
      background-color: #1a2633;
    }
  </style>
</head>
<body style="background-color: #333333;">
  <script src="../utilities.js"></script>
  <script src="geometry.js"></script>
  <script src="references.js"></script>
  <script src="regionAllocator.js"></script>
  <table>
    <tr>
      <td>

      </td>
    </tr>
    <tr>
      <td>
        <canvas id="a" width="1024" height="512"></canvas>
      </td>
    </tr>
    <tr>
      <td>
        <div id="aResults"></div>
      </td>
    </tr>
  </table>


  <script>
    var Geometry = Shumway.GFX.Geometry;
    var Matrix = Geometry.Matrix;
    var Point = Geometry.Point;
    var OBB = Geometry.OBB;
    var RenderableTileCache = Geometry.RenderableTileCache;
    var TileCache = Geometry.TileCache;

    var a = document.getElementById("a").getContext("2d");

    var aResults = document.getElementById("aResults");

    var W = 1024, H = 512;

  </script>
  <script>

    var points = Point.createEmptyPoints(4);

    function strokeLines(ctx, points) {
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      for (var i = 1; i < 4; i++) {
        ctx.lineTo(points[i].x, points[i].y);
      }
      ctx.closePath();
      ctx.stroke();
    }

    function strokeQuery(ctx, query, t, cache) {
      t.transformRectangle(query, points);
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      for (var i = 1; i < 4; i++) {
        ctx.lineTo(points[i].x, points[i].y);
      }
      ctx.closePath();
      ctx.stroke();
      ctx.strokeRect(0, 0, cache.w, cache.h);
    }

    function testA() {
      var cache = new TileCache(512, 512, 16, 16, 1);
      cache.tiles.forEach(function (t) {
        t.fillStyle = Shumway.ColorStyle.randomStyle();
      });

      var query = new Rectangle(256, 100, 128, 512);

      var transform = Matrix.createIdentity();

      var t = 0;


      setInterval(function () {
        t += 0.02;
        a.clearRect(0, 0, 1024, 1024);

        var transform = Matrix.createIdentity();
        transform.translate(-256, -256);
        transform.rotate(t);
        transform.scale(Math.sin(t), Math.sin(t));
        transform.translate(300, 300);
        var T = Matrix.createIdentity();
        transform.inverse(T);
        var tiles = cache.getTiles(query, T);
        a.strokeStyle = "white";
        a.strokeRect(query.x, query.y, query.w, query.h);

        strokeQuery(a, query, T, cache);

        a.save();
        // a.translate(transform.tx, transform.ty);
        a.setTransform(transform.a, transform.b, transform.c, transform.d, transform.tx, transform.ty);
        for (var i = 0; i < tiles.length; i++) {
          var tile = tiles[i];
          var c = tile.bounds;
          a.fillStyle = tile.fillStyle;
          a.fillRect(c.x, c.y, c.w, c.h);
        }
        a.restore();
      }, 16);
    }

    function testB() {
      var cache = new TileCache(512, 512, 8, 8, 1);
      cache.tiles.forEach(function (t) {
        t.fillStyle = Shumway.ColorStyle.randomStyle();
      });

      var query = new Rectangle(100, 100, 850, 128);

      var transform = Matrix.createIdentity();

      var t = 0;
      setInterval(function () {
        t += 0.01;
        a.clearRect(0, 0, 1024, 1024);

        var transform = Matrix.createIdentity();
        transform.translate(Math.sin(t) * 300, 0);
        transform.rotate(Math.sin(t) / 2);
        var T = Matrix.createIdentity();
        transform.inverse(T);
        var tiles = cache.getTiles(query, T);
        a.strokeStyle = "white";
        a.strokeRect(query.x, query.y, query.w, query.h);
        strokeQuery(a, query, T, cache);
        a.save();
        a.setTransform(transform.a, transform.b, transform.c, transform.d, transform.tx, transform.ty);
        for (var i = 0; i < tiles.length; i++) {
          var tile = tiles[i];
          var c = tile.bounds;
          a.fillStyle = tile.fillStyle;
          a.fillRect(c.x, c.y, c.w, c.h);
        }
        a.restore();
      }, 16);
    }

    function testC() {
      var cache = new TileCache(512, 512, 8, 8, 1);
      cache.tiles.forEach(function (t) {
        t.fillStyle = Shumway.ColorStyle.randomStyle();
      });

      var query = new Rectangle(100, 100, 400, 128);

      var transform = Matrix.createIdentity();

      var t = 0;
      setInterval(function () {
        t += 0.01;
        a.clearRect(0, 0, 1024, 1024);

        var transform = Matrix.createIdentity();
        transform.c = Math.sin(t);
        // transform.translate(Math.sin(t) * 300, 0);
        // transform.rotate(Math.sin(t) / 2);
        var T = Matrix.createIdentity();
        transform.inverse(T);

        var tiles = cache.getTiles(query, T);
        // var tiles = cache.tiles;

        a.strokeStyle = "white";
        a.strokeRect(query.x, query.y, query.w, query.h);

        strokeQuery(a, query, T, cache);

        a.save();
        a.setTransform(transform.a, transform.b, transform.c, transform.d, transform.tx, transform.ty);
        for (var i = 0; i < tiles.length; i++) {
          var tile = tiles[i];
          var c = tile.bounds;
          a.fillStyle = tile.fillStyle;
          a.fillRect(c.x, c.y, c.w, c.h);
        }
        a.restore();
      }, 16);
    }

    function testD() {
      var cache = new TileCache(512, 512, 8, 8, 1);
      cache.tiles.forEach(function (t) {
        t.fillStyle = Shumway.ColorStyle.randomStyle();
      });

      var query = new Rectangle(100, 100, 850, 128);

      var transform = Matrix.createIdentity();

      var t = 0;
      setInterval(function () {
        t += 0.02;

        var r = new Rectangle(0, 0, 100, 100);
        var A = Point.createEmptyPoints(4);
        var B = Point.createEmptyPoints(4);

        var t0 = Matrix.createIdentity();
        t0.translate(200, 200);
        t0.transformRectangle(r, A);

        var t1 = Matrix.createIdentity();
        t1.c = Math.sin(t);
        t1.b = Math.sin(t);
        t1.translate((Math.sin(t) + 1) * 80, (Math.sin(t) + 1) * 80);
        t1.transformRectangle(r, B);

        var oA = new OBB(A);
        var oB = new OBB(B);

        if (oA.intersects(oB)) {
          a.strokeStyle = "red";
        } else {
          a.strokeStyle = "white";
        }

        a.clearRect(0, 0, 1024, 1024);
        a.save();

        strokeLines(a, A);
        strokeLines(a, B);
        a.restore();
      }, 16);
    }

  </script>
  <br>
  <button onclick="testA()">Scale & Rotate</button>
  <button onclick="testB()">Translate & Rotate</button>
  <button onclick="testC()">Skew</button>
  <button onclick="testD()">OOB Check</button>
</body>
</html>