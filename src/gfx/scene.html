<!DOCTYPE html>
<html>
<head>
  <title></title>
  <style>
    body {
      color: white;
      font: 12px Consolas, "Liberation Mono", Courier, monospace;
    }
    canvas {
      background-color: #1a2633;
    }
  </style>
</head>

<script> console.time("Load Shared Dependencies"); </script>
<script src="../../build/ts/base.js"></script>
<script src="../../build/ts/tools.js"></script>
<script> console.timeEnd("Load Shared Dependencies"); </script>
<script> console.time("Load GFX Dependencies"); </script>
<script src="../../build/ts/gfx-base.js"></script>
<script src="../../build/ts/gfx.js"></script>
<script> console.timeEnd("Load GFX Dependencies"); </script>
<script>
  var release = false;
  var Node = Shumway.GFX.Node;
  var NodeVisitor = Shumway.GFX.NodeVisitor;
  var Matrix = Shumway.GFX.Geometry.Matrix;
  var Rectangle = Shumway.GFX.Geometry.Rectangle;
  var Stage = Shumway.GFX.Stage;
  var Shape = Shumway.GFX.Shape;
  var Group = Shumway.GFX.Group;
  var CustomRenderable = Shumway.GFX.CustomRenderable;
  var Canvas2DStageRenderer = Shumway.GFX.Canvas2D.Canvas2DStageRenderer;
  var Easel = Shumway.GFX.Easel;
  var Backend = Shumway.GFX.Backend;
  var BlendMode = Shumway.GFX.BlendMode;
</script>
<body style="background-color: #333333;">
  <table>
    <tr>
      <td>
        A (1024 x 1024)
      </td>
    </tr>
    <tr>
      <td>
        <div id="container" style="width: 512px; height: 512px"></div>
      </td>
    </tr>
    <tr>
      <td>

      </td>
    </tr>
  </table>
  <br>
  <button onclick="test()">Do</button>
  <button onclick="test2()">Shapes</button>
  <button onclick="garbage()">Garbage</button>
  <div id="log"></div>
  <div id="scratch"></div>
  <script>
    var logElement = document.getElementById("log");
    var scratchElement = document.getElementById("scratch");


    function log(s) {
      logElement.innerHTML += s + "<br>"
    }

    function dumpLine(line) {
      if (typeof dump !== "undefined") {
        dump(line + "\n");
      }
    }

    var container = document.getElementById("container");

    var easel = new Easel(container, Backend.Canvas2D)
    var stage = easel.stage;
    var world = easel.world;

    var lastTick = performance.now();
    function tick() {
      world.visit(Object.create(NodeVisitor.prototype, {
        visitTransform: {
          value: function (node) {
            node.x += node.dx;
            node.y += node.dy;
          }
        }
      }));
      var thisTick = performance.now();
      if (typeof dump !== "undefined") {
        var elapsed = (thisTick - lastTick);
        dumpLine("elapsedTime: " + Shumway.StringUtilities.repeatString("=", elapsed | 0) + " " + (elapsed).toFixed(2));
        dumpLine("Matrix: " + Matrix.allocationCount + ", " + "Rectangle: " + Rectangle.allocationCount);
        Matrix.allocationCount = Rectangle.allocationCount = 0;
      }
      lastTick = thisTick;
      requestAnimationFrame(tick);
    }

    tick();

    function makeCircle(w, h) {
      var color = "rgba(" + (Math.random() * 255 | 0) + ", " + (Math.random() * 255 | 0) + ", " + (Math.random() * 255 | 0) + ", 1)"
      return new CustomRenderable(new Rectangle(0, 0, w, h), function (context) {
        context.fillStyle = color;
        context.beginPath();
        context.arc(w / 2, h / 2, w / 2, 0, 2 * Math.PI);
        context.fill();
      });
    }

    function makeRenderable2(w, h) {
      var color = "rgba(" + (Math.random() * 255 | 0) + ", " + (Math.random() * 255 | 0) + ", " + (Math.random() * 255 | 0) + ", 1)"
      return new CustomRenderable(new Rectangle(0, 0, w, h), function (context) {
        context.fillStyle = color;
        context.fillRect(0, 0, w, h);
      });
    }

    function makeNode(depth, branch, w, h) {
      if (depth === 0) {
        return new Shape(makeCircle(w, h));
      } else {
        var group = new Group();
        for (var i = 0; i < branch; i++) {
          var node = makeNode(depth - 1, branch, w, h);
          group.addChild(node);
          node.getTransform().x = Math.random() * 128;
          node.getTransform().y = Math.random() * 128;
//          node.getTransform().dx = 10 * (Math.random() - 0.5) / depth;
//          node.getTransform().dy = 10 * (Math.random() - 0.5) / depth;

          node.getTransform().dx = (Math.random()) * 5;
          node.getTransform().dy = (Math.random()) * 5;

          // node.getLayer().blendMode = BlendMode.Normal;
          // node.getLayer().mask = new Shape(makeRenderable2(32, 32));

//          node.getLayer().mask._parent = node.getLayer(); // HACK

          // node.getLayer().mask.getTransform().x = 10;

        }
        return group;
      }
    }

    function test() {
      var count = 10;
      var depth = 8;
      for (var i = 0; i < count; i++) {
        world.addChild(makeNode(depth, 2, 2, 2));
      }
      log("Next Node ID: " + Node._nextId);
    }

    function test2() {
      var count = 10;
      var depth = 1;
      for (var i = 0; i < count; i++) {
        var node = makeNode(depth, 4, 64, 64);
        world.addChild(node);
      }
      log("Next Node ID: " + Node._nextId);
    }


    function test2() {
      var a = new Shape(makeCircle(64, 64));
      var t = a.getTransform();
      t.x = 100;
      t.y = 100;
      t.dx = 1;
      t.dy = 1;
      world.addChild(t);
    }

    function garbage() {
      setInterval(function () {
        for (var i = 0; i < 10000; i++) {
          new Array(1024);
        }
      });
    }

    function registerScratchCanvas(canvas) {
      scratchElement.appendChild(canvas);
    }
  </script>
</body>
</html>