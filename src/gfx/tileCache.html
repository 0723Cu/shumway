<!DOCTYPE html>
<html>
<head>
  <title></title>
  <style>
    body {
      color: white;
      font: 12px Consolas, "Liberation Mono", Courier, monospace;
    }

    canvas {
      background-color: #1a2633;
    }
  </style>
</head>
<body style="background-color: #333333;">
  <script src="../utilities.js"></script>
  <script src="geometry.js"></script>
  <script src="references.js"></script>
  <script src="regionAllocator.js"></script>
  <table>
    <tr>
      <td>

      </td>
    </tr>
    <tr>
      <td>
        <canvas id="a" width="1024" height="512"></canvas>
      </td>
    </tr>
    <tr>
      <td>
        <div id="aResults"></div>
      </td>
    </tr>
  </table>


  <script>
    var Geometry = Shumway.GFX.Geometry;
    var Matrix = Geometry.Matrix;
    var Point = Geometry.Point;
    var OBB = Geometry.OBB;
    var RenderableTileCache = Geometry.RenderableTileCache;
    var TileCache = Geometry.TileCache;

    var a = document.getElementById("a").getContext("2d");

    var aResults = document.getElementById("aResults");

    var W = 1024, H = 512;

  </script>
  <script>

    var points = Point.createEmptyPoints(4);

    function strokeLines(ctx, points) {
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      for (var i = 1; i < 4; i++) {
        ctx.lineTo(points[i].x, points[i].y);
      }
      ctx.closePath();
      ctx.stroke();
    }

    function strokeQuery(ctx, query, t, cache) {
      t.transformRectangle(query, points);
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      for (var i = 1; i < 4; i++) {
        ctx.lineTo(points[i].x, points[i].y);
      }
      ctx.closePath();
      ctx.stroke();
      ctx.strokeRect(0, 0, cache.w, cache.h);
    }

    function testA() {
      var cache = new TileCache(512, 512, 16, 16, 1);
      cache.tiles.forEach(function (t) {
        t.fillStyle = Shumway.ColorStyle.randomStyle();
      });

      var query = new Rectangle(256, 100, 128, 512);

      var transform = Matrix.createIdentity();

      var t = 0;


      setInterval(function () {
        t += 0.02;
        a.clearRect(0, 0, 1024, 1024);

        var transform = Matrix.createIdentity();
        transform.translate(-256, -256);
        transform.rotate(t);
        transform.scale(Math.sin(t), Math.sin(t));
        transform.translate(300, 300);
        var T = Matrix.createIdentity();
        transform.inverse(T);
        var tiles = cache.getTiles(query, T);
        a.strokeStyle = "white";
        a.strokeRect(query.x, query.y, query.w, query.h);

        strokeQuery(a, query, T, cache);

        a.save();
        // a.translate(transform.tx, transform.ty);
        a.setTransform(transform.a, transform.b, transform.c, transform.d, transform.tx, transform.ty);
        for (var i = 0; i < tiles.length; i++) {
          var tile = tiles[i];
          var c = tile.bounds;
          a.fillStyle = tile.fillStyle;
          a.fillRect(c.x, c.y, c.w, c.h);
        }
        a.restore();
      }, 16);
    }

    function testB() {
      var cache = new TileCache(512, 512, 8, 8, 1);
      cache.tiles.forEach(function (t) {
        t.fillStyle = Shumway.ColorStyle.randomStyle();
      });

      var query = new Rectangle(100, 100, 850, 128);

      var transform = Matrix.createIdentity();

      var t = 0;
      setInterval(function () {
        t += 0.01;
        a.clearRect(0, 0, 1024, 1024);

        var transform = Matrix.createIdentity();
        transform.translate(Math.sin(t) * 300, 0);
        transform.rotate(Math.sin(t) / 2);
        var T = Matrix.createIdentity();
        transform.inverse(T);
        var tiles = cache.getTiles(query, T);
        a.strokeStyle = "white";
        a.strokeRect(query.x, query.y, query.w, query.h);
        strokeQuery(a, query, T, cache);
        a.save();
        a.setTransform(transform.a, transform.b, transform.c, transform.d, transform.tx, transform.ty);
        for (var i = 0; i < tiles.length; i++) {
          var tile = tiles[i];
          var c = tile.bounds;
          a.fillStyle = tile.fillStyle;
          a.fillRect(c.x, c.y, c.w, c.h);
        }
        a.restore();
      }, 16);
    }

    function testC() {
      var cache = new TileCache(512, 512, 8, 8, 1);
      cache.tiles.forEach(function (t) {
        t.fillStyle = Shumway.ColorStyle.randomStyle();
      });

      var query = new Rectangle(100, 100, 400, 128);

      var transform = Matrix.createIdentity();

      var t = 0;
      setInterval(function () {
        t += 0.01;
        a.clearRect(0, 0, 1024, 1024);

        var transform = Matrix.createIdentity();
        transform.c = Math.sin(t);
        // transform.translate(Math.sin(t) * 300, 0);
        // transform.rotate(Math.sin(t) / 2);
        var T = Matrix.createIdentity();
        transform.inverse(T);

        var tiles = cache.getTiles(query, T);
        // var tiles = cache.tiles;

        a.strokeStyle = "white";
        a.strokeRect(query.x, query.y, query.w, query.h);

        strokeQuery(a, query, T, cache);

        a.save();
        a.setTransform(transform.a, transform.b, transform.c, transform.d, transform.tx, transform.ty);
        for (var i = 0; i < tiles.length; i++) {
          var tile = tiles[i];
          var c = tile.bounds;
          a.fillStyle = tile.fillStyle;
          a.fillRect(c.x, c.y, c.w, c.h);
        }
        a.restore();
      }, 16);
    }

    function testD() {
      var cache = new TileCache(512, 512, 8, 8, 1);
      cache.tiles.forEach(function (t) {
        t.fillStyle = Shumway.ColorStyle.randomStyle();
      });

      var query = new Rectangle(100, 100, 850, 128);

      var transform = Matrix.createIdentity();

      var t = 0;
      setInterval(function () {
        t += 0.02;

        var r = new Rectangle(0, 0, 100, 100);
        var A = Point.createEmptyPoints(4);
        var B = Point.createEmptyPoints(4);

        var t0 = Matrix.createIdentity();
        t0.translate(200, 200);
        t0.transformRectangle(r, A);

        var t1 = Matrix.createIdentity();
        t1.c = Math.sin(t);
        t1.b = Math.sin(t);
        t1.translate((Math.sin(t) + 1) * 80, (Math.sin(t) + 1) * 80);
        t1.transformRectangle(r, B);

        var oA = new OBB(A);
        var oB = new OBB(B);

        if (oA.intersects(oB)) {
          a.strokeStyle = "red";
        } else {
          a.strokeStyle = "white";
        }

        a.clearRect(0, 0, 1024, 1024);
        a.save();

        strokeLines(a, A);
        strokeLines(a, B);
        a.restore();
      }, 16);
    }

    function strokeOrFillPath(ctx, path, stroke) {
      ctx.beginPath();
      ctx.moveTo(path[0][0], path[0][1]);
      for (var i = 1; i < path.length; i ++) {
        var cmd = path[i];
        if (cmd.length === 2) {
          ctx.lineTo(cmd[0], cmd[1]);
        } else if (cmd.length === 4) {
          ctx.quadraticCurveTo(cmd[0], cmd[1], cmd[2], cmd[3]);
        }
      }
      ctx.closePath();
      if (stroke) {
        ctx.stroke();
      } else {
        ctx.fill("evenodd");
      }
    }

    function strokeOrFillPolygon(ctx, polygon, stroke) {
      ctx.beginPath();
      ctx.moveTo(polygon[0], polygon[1]);
      for (var i = 2; i < polygon.length; i += 2) {
        ctx.lineTo(polygon[i], polygon[i + 1]);
      }
      if (stroke) {
        ctx.stroke();
      } else {
        ctx.fill("evenodd");
      }
    }

    function testE() {

      var polygon = new Float32Array(128);
      for (var i = 0; i < polygon.length - 2; i += 2) {
        polygon[i + 0] = Math.random() * W;
        polygon[i + 1] = Math.random() * H;
      }
      polygon[i + 0] = polygon[0];
      polygon[i + 1] = polygon[1];

      var x = 0, y = 100;
      setInterval(function () {

        x += 1;
        a.clearRect(0, 0, 1024, 1024);
        var s = Date.now();
        for (var i = 0; i < 10000; i++) {
          var r = Shumway.GeometricUtilities.pointInPolygon(x, y, polygon);
        }
        aResults.innerHTML = "Query Time: " + ((Date.now() - s) / 10000) + " ms";
        if (r) {
          a.fillStyle = "green";
        } else {
          a.fillStyle = "white";
        }
        strokeOrFillPolygon(a, polygon, false);
        strokeOrFillPolygon(a, polygon, true);
        a.fillStyle = "white";
        a.fillRect(x - 2, y - 2, 4, 4);

      }, 16);
    }

    function testF() {
      var paths = [
        // [[287, 291.65], [289.1, 291.8], [306.15, 293.45, 308.25, 313.1], [306.65, 331.9, 283.95, 334.35], [91, 334.35], [89.5, 334.65], [15.4, 348.9, 6.1, 425.8], [15.25, 502.7, 96.45, 514.3], [510.7, 514.3], [511.25, 514.25], [584.1, 508.95, 596.5, 429.45], [602.7, 370.9], [608.8, 312.8, 596.65, 201.15], [596.65, 200.15], [594.15, 129.35, 515.95, 112.5]],
        [[515.95, 112.5], [514.8, 112.3], [411.4, 81], [368.45, 68.15, 306.5, 56.3], [300.9, 56.35], [297.95, 56.45], [246.25, 61.65, 194.6, 111.8], [96.4, 111.8], [94.25, 112], [14.1, 121.7, 6.4, 203.3], [6.4, 203.5], [9.2, 273.55, 93.2, 291.55], [93.75, 291.65], [287, 291.65], [289.1, 291.8], [306.15, 293.45, 308.25, 313.1], [306.65, 331.9, 283.95, 334.35], [91, 334.35], [89.5, 334.65], [15.4, 348.9, 6.1, 425.8], [15.25, 502.7, 96.45, 514.3], [510.7, 514.3], [511.25, 514.25], [584.1, 508.95, 596.5, 429.45], [602.7, 370.9], [608.8, 312.8, 596.65, 201.15], [596.65, 200.15], [594.15, 129.35, 515.95, 112.5]],
        // [[392.8, 181.1], [458.2, 181.1], [460.35, 181], [481.85, 180.15, 483.7, 203.25], [483.85, 205.9], [459.35, 318.5, 483.85, 427.2], [481.7, 444.6, 460.3, 445.8], [458.2, 445.9], [100.15, 445.9], [97.85, 445.55], [76.25, 441.95, 75.7, 425.45], [77.15, 404.75, 97.4, 402.15], [339.2, 402.15], [424.4, 384.85, 421.45, 312.15], [419, 234.75, 339.75, 223.6], [337.05, 223.25], [125.65, 223.25], [105.35, 220.8, 103.3, 202.7], [106.65, 180, 127.85, 180.1], [195.95, 180.1], [199.65, 179.85], [249.15, 176.1, 273.25, 142.1], [278.95, 127.95, 299.75, 124.7], [323.4, 122.75, 332.4, 143.1], [349.1, 175.2, 391.6, 180.95], [392.8, 181.1]],
        [[392.8, 181.1], [458.2, 181.1], [460.35, 181], [481.85, 180.15, 483.7, 203.25], [483.85, 205.9], [459.35, 318.5, 483.85, 427.2], [481.7, 444.6, 460.3, 445.8], [458.2, 445.9], [100.15, 445.9], [97.85, 445.55], [76.25, 441.95, 75.7, 425.45], [77.15, 404.75, 97.4, 402.15], [339.2, 402.15], [424.4, 384.85, 421.45, 312.15], [419, 234.75, 339.75, 223.6], [337.05, 223.25], [125.65, 223.25], [105.35, 220.8, 103.3, 202.7], [106.65, 180, 127.85, 180.1], [195.95, 180.1], [199.65, 179.85], [249.15, 176.1, 273.25, 142.1], [278.95, 127.95, 299.75, 124.7], [323.4, 122.75, 332.4, 143.1], [349.1, 175.2, 392.6, 180.95]],
        // [[628.15, 34.05], [628.15, 537.2], [-13, 537.2], [-13, 34.05], [628.15, 34.05]]
      ];

      for (var i = 0; i < paths.length; i++) {
        paths[i].style = Shumway.ColorStyle.randomStyle();
      }
      var pointInPolygon = Shumway.GeometricUtilities.pointInPolygon;
      var clockwise = Shumway.GeometricUtilities.clockwise;

      var polygons = [];
      for (var i = 0; i < paths.length; i++) {
        var path = paths[i];
        var points = [];
        var x0 = 0, y0 = 0;
        for (var j = 0; j < path.length; j++) {
          var command = path[j];
          if (command.length === 2) {
            var x0 = command[0], y0 = command[1];
            points.push(x0, y0);
          } else {
            var x1 = command[0], y1 = command[1];
            var x2 = command[2], y2 = command[3];
            if (!clockwise(x0, y0, x1, y1, x2, y2)) {
              points.push(x1, y1, x2, y2);
            } else {
              points.push(x2, y2);
            }
          }
        }
        points.push(points[0]);
        points.push(points[1]);
        polygons.push(new Float32Array(points));
      }

      var x = 0, y = 100;
      setInterval(function () {

        x += 1;
        a.clearRect(0, 0, 1024, 1024);
        var s = Date.now();

        paths.forEach(function (p) {
          a.fillStyle = p.style;
          strokeOrFillPath(a, p, false);
        });

        polygons.forEach(function (p) {
          strokeOrFillPolygon(a, p, true);
        });

//        aResults.innerHTML = "Query Time: " + ((Date.now() - s) / 10000) + " ms";
//        if (r) {
//          a.fillStyle = "green";
//        } else {
//          a.fillStyle = "white";
//        }
        a.fillStyle = "white";
        a.fillRect(x - 2, y - 2, 4, 4);

      }, 16);
    }

  </script>
  <br>
  <button onclick="testA()">Scale & Rotate</button>
  <button onclick="testB()">Translate & Rotate</button>
  <button onclick="testC()">Skew</button>
  <button onclick="testD()">OOB Check</button>
  <button onclick="testE()">Point in Polygon Test</button>
  <button onclick="testF()">Point in Polygon Test 2</button>
</body>
</html>