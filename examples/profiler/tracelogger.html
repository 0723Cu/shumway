<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TraceLogger Demo</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="bootstrap-select.min.css">
  <link rel="stylesheet" href="index.css">
</head>
<body>

  <div class="row-fluid">
    <div id="form" style="display: inline-block;">
      <select id="engines-menu" class="selectpicker" style="display: none;"></select>
      <select id="suites-menu" class="selectpicker" style="display: none;"></select>
      <select id="scripts-menu" class="selectpicker" style="display: none;"></select>
    </div>
    <button id="submit" type="button" class="btn btn-primary">Load</button>
  </div>

  <div id="progress" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div id="progress-bar" class="progress progress-striped">
          <div class="progress-bar"  role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
            <span class="sr-only">0% Complete</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="container"></div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  <script src="bootstrap-select.min.js"></script>
  <script src="../../build/ts/utilities.js"></script>
  <script src="../../build/ts/tools/profiler/references.js"></script>
  <script src="../../build/ts/tools/profiler/profile.js"></script>
  <script src="../../build/ts/tools/profiler/controller.js"></script>
  <script src="../../build/ts/tools/profiler/mouseController.js"></script>
  <script src="../../build/ts/tools/profiler/flameChartBase.js"></script>
  <script src="../../build/ts/tools/profiler/flameChart.js"></script>
  <script src="../../build/ts/tools/profiler/flameChartHeader.js"></script>
  <script src="../../build/ts/tools/profiler/flameChartOverview.js"></script>
  <script src="../../build/ts/tools/profiler/timelineFrame.js"></script>
  <script src="../../build/ts/tools/profiler/timelineBuffer.js"></script>
  <script src="../../build/ts/tools/profiler/tracelogger/traceLogger.js"></script>
  <script src="../../build/ts/tools/profiler/tracelogger/thread.js"></script>
  <script src="../../build/ts/tools/profiler/theme/ui.js"></script>
  <script src="data/tracelogger/data.js"></script>
  <script>

    if (!jsGlobal.performance) { jsGlobal.performance = {}; }
    if (!jsGlobal.performance.now) { jsGlobal.performance.now = Date.now; }

    var container = document.getElementById("container");
    var Profiler = Shumway.Tools.Profiler;
    var TraceLogger = Shumway.Tools.Profiler.TraceLogger;

    var traceLogger = new TraceLogger.TraceLogger("data/tracelogger/");
    var controller;

    function load(name) {
      traceLogger.loadPage(name, onLoad, onProgress);
    }

    function onLoad(err, threads) {
      setTimeout(function() {
        setProgress(0);
        setModalVisibility(false);
        var profile = new Profiler.Profile();
        for (var i = 0, n = threads.length; i < n; i++) {
          profile.addBuffer(threads[i].buffer, "Thread " + i);
        }
        if (controller) { controller.reset(); }
        controller = new Profiler.Controller(profile, container);
        controller.createSnapshot();
      }, 400);
    }

    function onProgress(info) {
      setProgress(Math.round(info.threadFilesLoaded * 100 / info.threadFilesTotal));
    }

    /**
     * User interface
     */

    var engine = TLData.engines[0];
    var suite = TLData.suites[0];
    var script = suite.scripts[0];

    var $engines = $("#engines-menu");
    var $suites = $("#suites-menu");
    var $scripts = $("#scripts-menu");

    function initEngines(refresh) {
      $engines.empty();
      for(var i = 0; i < TLData.engines.length; i++) {
        $engines.append($("<option>").text(TLData.engines[i].name).attr("value", TLData.engines[i].name));
      }
      !refresh || $engines.selectpicker("refresh");
    }

    function initSuites(refresh) {
      $suites.empty();
      for(var i = 0; i < TLData.suites.length; i++) {
        $suites.append($("<option>").text(TLData.suites[i].name).attr("value", TLData.suites[i].name));
      }
      !refresh || $suites.selectpicker("refresh");
    }

    function initScripts(refresh) {
      $scripts.empty();
      for(var i = 0; i < suite.scripts.length; i++) {
        $scripts.append($("<option>").text(suite.scripts[i].name).attr("value", suite.scripts[i].name));
      }
      !refresh || $scripts.selectpicker("refresh");
    }

    initEngines();
    initSuites();
    initScripts();

    $(".selectpicker").selectpicker({ width: "auto" });
    $("#progress").modal({ backdrop: "static", keyboard: false, show: false });

    $engines.on("change", function() {
      selectEngine($(this).val());
    });
    $suites.on("change", function() {
      selectSuite($(this).val());
    });
    $scripts.on("change", function() {
      selectScript($(this).val());
    });

    $("#submit").on("click", function() {
      setModalVisibility(true);
      load("data-" + suite.name + "-" + engine.name + "-" + script.name + ".json");
    });

    function selectEngine(name) {
      for(var i = 0; i < TLData.engines.length; i++) {
        if (TLData.engines[i].name === name) {
          if (engine !== TLData.engines[i]) {
            engine = TLData.engines[i];
          }
          break;
        }
      }
    }

    function selectSuite(name) {
      for(var i = 0; i < TLData.suites.length; i++) {
        if (TLData.suites[i].name === name) {
          if (suite !== TLData.suites[i]) {
            suite = TLData.suites[i];
            script = suite.scripts[0];
            initScripts(true);
          }
          break;
        }
      }
    }

    function selectScript(name) {
      for(var i = 0; i < suite.scripts.length; i++) {
        if (suite.scripts[i].name === name) {
          if (script !== suite.scripts[i]) {
            script = suite.scripts[i];
          }
          break;
        }
      }
    }

    function setProgress(percent) {
      var $bar = $("#progress-bar > .progress-bar");
      $bar.width(percent + "%");
      $("span", $bar).text(percent + "% Complete");
    }

    function setModalVisibility(visible) {
      $("#progress").modal(visible ? "show" : "hide")
    }

  </script>
</body>
</html>
