<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Shumway AVM Web Shell</title>
</head>
<body>
    <script type="text/javascript">
        print = function (message) {
            console.log(message);
        };
        
        var webShell = true;
        
    </script>
    
    Parse ( + Compile: <input name="compile" type="checkbox" id="compile" value="Y"> )
    (Break on First Error <input name="break" type="checkbox" id="break" value="Y"> )<br>
    <button onclick="runAll();">Run All</button><input type="text" id="runAllText" value="0:*"/>
    <button onclick="runOne();">Run One</button><input type="text" id="runOneText" value="abc/1-0.abc"/>
    
    <!--  
    
    This page runs each of the test cases listed in tests/abc.list and which are found in tests/abc/. 
    Unpack abc.tar.gz in tests/abc/ and run "ls tests/abc > tests/abc.list" to create a list of tests
    that this page can read and iterate over.
    
    -->
    
    <script type="text/javascript" src="util.js"></script>
    <script type="text/javascript" src="file-reader.js"></script>
    <script type="text/javascript" src="avm2-runtime.js"></script>
    <script type="text/javascript" src="DataView.js"></script>
    <script type="text/javascript" src="constants.js"></script>
    <script type="text/javascript" src="parser.js"></script>
    <script type="text/javascript" src="compiler.js"></script>
    <script type="text/javascript" src="interpreter.js"></script>
    <script type="text/javascript">
    
        new FileReader("tests/testInterpreter.abc").readAll(null, function (buffer) {
            var abc = parseAbcFile(new Uint8Array(buffer));
            interpretAbc(abc);
        });
    
        function runOne() {
            var file = document.getElementById('runOneText').value;
            new FileReader("tests/" + file).readAll(null, function (buffer) {
                var start = Date.now();
                var ret = "OK";
                try {
                    var abc = parseAbcFile(new Uint8Array(buffer));
                    if (document.getElementById('compile').checked) {
                      compileAbc(abc);
                    }
                } catch (e) {
                    ret = "FAIL: " + e + e.stack;
                    failed++;
                }
                appendResult({number: 0, test: file, elapsed: (Date.now() - start), ret: ret});
            });
        }
        
        function runAll() {
          var range = document.getElementById('runAllText').value.split(":");
          var total = 0;
          var failed = 0;
          new FileReader("tests/abc.list", "text").readAll(null, function(text) {
              var files = text.split("\n");
              var from = parseInt(range[0]);
              var to = range.length <= 1 ? from + 1 : range[1] == "*" ? files.length : parseInt(range[1]);
              total = to - from;
              var index = from;
              setTimeout(function next() {
                  if (index >= to) {
                      console.info("Failed: " + failed + " out of " + total);
                      return;
                  }
                  var file = files[index];
                  var number = index;
                  new FileReader("tests/abc/" + file).readAll(null, function (buffer) {
                      var start = Date.now();
                      var ret = "OK";
                      try {
                          var abc = parseAbcFile(new Uint8Array(buffer));
                          if (document.getElementById('compile').checked) {
                              compileAbc(abc);
                          }
                      } catch (e) {
                          ret = "FAIL: " + e + e.stack;
                          failed++;
                          if (document.getElementById('break').checked) {
                              throw e;
                          }
                      }
                      appendResult({number: number, test: file, elapsed: (Date.now() - start), ret: ret});
                      setTimeout(next, 1);
                  });
                  index ++;
              }, 1);
          });
        }
        
        function appendResult(result) {
            var table = document.getElementById('results');
            var row = document.createElement("tr");
            for (var val in result) {
                var cell = document.createElement("td");1
                cell.appendChild(document.createTextNode(result[val]));
                row.appendChild(cell);
            }
            if (result.ret == "OK") {
                row.setAttribute("class", "success");
            } else {
                row.setAttribute("class", "failure");
            }
            table.appendChild(row);
        }
        
    </script>
    <style>
        body {
            font-family: verdana;
            font-size: 12px;
        }
        
        .success {
            color: green;
        }
        
        .failure {
            color: red;
        }
    </style>
    <table id="results">
        <tr>
            <td style="width: 50px">#</td>
            <td style="width: 200px">Test</td>
            <td style="width: 100px">Time (ms)</td>
            <td>Result</td>
        </tr>
    </table>
</body>
</html>
