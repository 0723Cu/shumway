<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Shumway Web Shell</title>
</head>
<body>
    <script type="text/javascript">
      print = function(message) {
        console.log(message);
      };

      var webShell = true;

      function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
          var pair = vars[i].split("=");
          if (pair[0] == variable) {
            return unescape(pair[1]);
          }
        }
        return undefined;
      }
    </script>

    <script>
      var SWF = {};
    </script>

    <script type="text/javascript" src="../../swf/util.js"></script>
    <script type="text/javascript" src="../../swf/types.js"></script>
    <script type="text/javascript" src="../../swf/structs.js"></script>
    <script type="text/javascript" src="../../swf/tags.js"></script>
    <script type="text/javascript" src="../../swf/inflate.js"></script>
    <script type="text/javascript" src="../../swf/stream.js"></script>
    <script type="text/javascript" src="../../swf/templates.js"></script>
    <script type="text/javascript" src="../../swf/generator.js"></script>
    <script type="text/javascript" src="../../swf/parser.js"></script>
    <script type="text/javascript" src="../../swf/bitmap.js"></script>
    <script type="text/javascript" src="../../swf/button.js"></script>
    <script type="text/javascript" src="../../swf/font.js"></script>
    <script type="text/javascript" src="../../swf/image.js"></script>
    <script type="text/javascript" src="../../swf/label.js"></script>
    <script type="text/javascript" src="../../swf/shape.js"></script>
    <script type="text/javascript" src="../../swf/text.js"></script>

    <script type="text/javascript" src="../util.js"></script>
    <script type="text/javascript" src="../metrics.js"></script>
    <script type="text/javascript" src="../options.js"></script>

    <script>
      var Timer = metrics.Timer;
      var Option = options.Option;
      var OptionSet = options.OptionSet;
      var systemOptions = new OptionSet("System Options");
      var disassemble = systemOptions.register(new Option("d", "disassemble", "boolean", false, "disassemble"));
    </script>

    <script src="../../../lib/DataView.js/DataView.js"></script>
    <script type="text/javascript" src="../constants.js"></script>
    <script type="text/javascript" src="../opcodes.js"></script>
    <script type="text/javascript" src="../parser.js"></script>
    <script type="text/javascript" src="../analyze.js"></script>
    <script type="text/javascript" src="../viz.js"></script>

    <script type="text/javascript" src="../compiler/lljs/src/estransform.js"></script>
    <script type="text/javascript" src="../compiler/lljs/src/escodegen.js"></script>
    <script type="text/javascript" src="../compiler/compiler.js"></script>

    <script type="text/javascript" src="../native.js"></script>

    <script type="text/javascript" src="../domain.js"></script>
    <script type="text/javascript" src="../runtime.js"></script>
    <script type="text/javascript" src="../disassembler.js"></script>
    <script type="text/javascript" src="../interpreter.js"></script>

    <script type="text/javascript">
      var FileReader = (function fileReader() {
        function constructor(url, responseType) {
          this.url = url;
          this.responseType = responseType || "arraybuffer";
        }

        constructor.prototype = {
          readAll: function(progress, complete) {
            var xhr = new XMLHttpRequest();
            var async = true;
            xhr.open("GET", this.url, async);
            xhr.responseType = this.responseType;
            if (progress) {
              xhr.onprogress = function(event) {
                progress(xhr.response, event.loaded, event.total);
              };
            }
            xhr.onreadystatechange = function(event) {
              if (xhr.readyState === 4) {
                complete(xhr.response);
              }
            }
            xhr.setRequestHeader("If-Modified-Since", "Fri, 01 Jan 1960 00:00:00 GMT"); // no-cache
            xhr.send(null);
          }
        };
        return constructor;
      })();
    </script>

    <script type="text/javascript">

      var sysDomain = new Domain(null, ALWAYS_INTERPRET, true);

      var loadPlayerGlobal = true;
      var file = getQueryVariable("file") || "../tests/watch.swf";

      var queue = [];

      /**
       * Chains together a bunch of I/O callbacks to intialize the sys and app domains.
       */

      queue.push(function () {
        new FileReader("../generated/builtin.abc").readAll(null, function (buffer) {
          sysDomain.executeAbc(new AbcFile(new Uint8Array(buffer), "builtin.abc", true));
          executeNext();
        });
      });

      if (loadPlayerGlobal) {
        queue.push(function () {
          new FileReader("../generated/playerGlobal.swf").readAll(null, function (buffer) {
            SWF.parse(buffer, {
              oncomplete: function(result) {
                var tags = result.tags;
                for (var i = 0, n = tags.length; i < n; i++) {
                  var tag = tags[i];
                  if (tag.type === "abc") {
                    sysDomain.loadAbc(new AbcFile(tag.data, "playerGlobal/library" + i + ".abc"));
                  }
                }
              }
            });
            executeNext();
          });
        });
      }

      var appDomain = new Domain(sysDomain, ALWAYS_INTERPRET, false);

      if (file.endsWith(".swf")) {
        queue.push(function() {
          new FileReader(file).readAll(null, function(buffer) {
            SWF.parse(buffer, {
              oncomplete: function(result) {
                var tags = result.tags;
                for (var i = 0, n = tags.length; i < n; i++) {
                  var tag = tags[i];
                  if (tag.type === "abc") {
                    appDomain.loadAbc(new AbcFile(tag.data, "playerGlobal/library" + i + ".abc"));
                  } else if (tag.type === "symbols") {
                    for (var j = tag.references.length - 1; j >= 0; j--) {
                      if (tag.references[j].id === 0) {
                        appDomain.getProperty(
                          Multiname.fromSimpleName(tag.references[j].name),
                          true, true
                        );
                        break;
                      }
                    }
                  }
                }
              }
            });
            executeNext();
          });
        });
      } else {
        queue.push(function () {
          new FileReader(file).readAll(null, function (buffer) {
            sysDomain.executeAbc(new AbcFile(new Uint8Array(buffer), file, true));
            executeNext();
          });
        });
      }

      function executeNext() {
        if (queue.length === 0) {
          return;
        }
        queue.shift()();
      }

      executeNext();
    </script>
</body>
</html>
